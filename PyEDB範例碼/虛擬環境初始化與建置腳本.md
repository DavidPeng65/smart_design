虛擬環境初始化與建置腳本
---

這段 Windows 批次檔用於自動偵測安裝於系統上的 ANSYSEM 軟體版本，並根據最新版本設定對應 Python 環境。若尚未建立虛擬環境（venv），會自動建立並安裝必要套件，最後執行 `main.py` 腳本。

主要目的是為了將整個專案資料夾複製到其他電腦時，仍能快速建立可運行的環境，降低人工安裝的成本與錯誤率。不需要複製 `.venv` 資料夾，避免攜帶過大檔案，只需保留必要的原始程式與這個批次檔，即可在新機器上重新建立虛擬環境與安裝套件。

### 功能

* 自動偵測系統中最新的 ANSYSEM\_ROOT 環境變數
* 搜尋對應版本下的 Python 執行檔
* 建立並啟用 Python 虛擬環境 `.venv`
* 初次執行時自動安裝 `pyaedt`, `pyedb`, `flask` 等必要套件
* 最後執行 `main.py`

### 流程架構

1. **選擇最新版本的 ANSYSEM\_ROOTxxx**：

   * 預設從多個已知版本號碼中（如 260、252...）找出環境變數已定義者，並挑選版本號最大的作為最新版本。

2. **尋找 Python 路徑**：

   * 根據選出的 ANSYSEM\_ROOT 路徑，往 `../commonfiles/CPython` 搜尋 `python.exe`

3. **建立/啟用虛擬環境與安裝套件**：

   * 若 `.venv` 尚未存在，則建立虛擬環境並安裝必要 Python 套件
   * 若已存在，則直接啟用虛擬環境，跳過安裝流程

4. **執行主程式**：

   * 嘗試執行當前資料夾下的 `main.py`

### 補充說明

* `call set "val=%%ANSYSEM_ROOT%%V%%"` 是一種技巧，透過間接展開來取得 `ANSYSEM_ROOTxxx` 的值
* `enabledelayedexpansion` 用於讓迴圈內的變數即時生效，例如 `!val!`
* `curl -I https://pypi.org` 用來檢查是否可以連上 PyPI（Python 套件下載站）
* `.venv_installed.flag` 是安裝完成的標記檔，雖然在這段中僅寫入，未使用

### 範例程式

```batch
@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

set versions=260 252 251 242 241 232
set "latest_version=0"
set "latest_root="

for %%V in (%versions%) do (
    call set "val=%%ANSYSEM_ROOT%%V%%"
    if defined val (
        echo ✅ 找到 ANSYSEM_ROOT%%V%% = !val!
        if %%V GTR !latest_version! (
            set "latest_version=%%V"
            set "latest_root=!val!"
        )
    )
)

if not defined latest_root (
    echo ❌ 無法找到任何 ANSYSEM_ROOTxxx 環境變數
    pause
    exit /b
)

echo ✅ 最新版本為 ANSYSEM_ROOT%latest_version%
echo 📁 對應路徑：!latest_root!

set "search_root=!latest_root!\..\commonfiles\CPython"
set "PYTHON_PATH="

for /f "delims=" %%F in ('dir /b /s /a-d "!search_root!\python.exe" 2^>nul') do (
    set "PYTHON_PATH=%%F"
)

if not defined PYTHON_PATH (
    echo ❌ 找不到 python.exe
    pause
    exit /b
)

echo ✅ 使用 Python：!PYTHON_PATH!

if not exist ".venv" (
    echo 🛠️ 建立 .venv...
    "!PYTHON_PATH!" -m venv ".venv"
    if errorlevel 1 (
        echo ❌ venv 建立失敗
        pause
        exit /b
    )

    call ".venv\Scripts\activate.bat"
    if errorlevel 1 (
        echo ❌ 無法啟用虛擬環境 .venv
        pause
        exit /b
    )

    echo 🌐 檢查與 PyPI 的連線狀態...
    curl -I https://pypi.org -m 5 -o nul -s -S
    if %errorlevel%==0 (
        echo ✅ PyPI 連線正常，開始安裝套件...
        python -m pip install --upgrade pip
        pip install pyaedt pyedb flask
        echo 已完成安裝 > ".venv_installed.flag"
    ) else (
        echo ❌ 無法連線至 PyPI (https://pypi.org)
        echo 🔒 可能原因：防火牆 / 代理伺服器 / 網路策略限制
        echo 🛑 安裝中止；請確認網路環境後再執行（或先行離線安裝）
        pause
        exit /b
    )
) else (
    echo 📦 偵測到已存在 .venv，略過建立與 pip 安裝
    call ".venv\Scripts\activate.bat"
)

if exist "main.py" (
    echo ▶️ 執行 main.py...
    python main.py
) else (
    echo ❌ 找不到 main.py，請將它放在此資料夾
)

endlocal
pause
```
