第8章. 架構雲端Linux集群
---

Azure CLI 是一個命令列工具，讓您可以使用命令列來管理 Azure 資源。透過 Azure CLI，您可以自動化資源建立、配置和管理的流程，而不需要透過 Azure 入口網站進行手動操作。

#### 如何安裝 Azure CLI 

您可以在 Windows、macOS 或 Linux 上安裝 Azure CLI，具體步驟如下：
 
1. **Linux** ：

```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
 
2. **macOS** ：
使用 Homebrew 安裝：

```bash
brew update && brew install azure-cli
```
 
3. **Windows** ： 
  - 您可以下載 Azure CLI MSI 安裝包並安裝：[Azure CLI MSI 安裝包]()

  - 或者透過 Windows Subsystem for Linux (WSL) 使用 Linux 版本的 Azure CLI。

安裝完成後，您可以使用以下指令來檢查是否安裝成功：


```bash
az --version
```

#### 登入 Azure 帳戶 

在使用 Azure CLI 管理資源之前，必須先登入 Azure 帳戶：


```bash
az login
```

此指令會打開瀏覽器，並提示您輸入 Azure 帳戶的使用者名稱和密碼。一旦登入成功，終端機會顯示相關的訂閱資訊。

#### 常見的 Azure CLI 指令 
Azure CLI 中的指令都是以 `az` 開頭的，並跟隨資源類型和操作。以下是一些常見指令： 
1. **建立資源群組** ：

```bash
az group create --name <resource-group-name> --location <location>
```
 
2. **建立虛擬機器** ：

```bash
az vm create --resource-group <resource-group-name> --name <vm-name> --image UbuntuLTS --size Standard_D2s_v3 --admin-username <username> --ssh-key-values <path-to-ssh-public-key>
```
 
3. **檢視虛擬機器列表** ：

```bash
az vm list --output table
```
 
4. **刪除資源群組** （將會刪除資源群組下的所有資源）：

```bash
az group delete --name <resource-group-name>
```

#### 自動化工作流 
Azure CLI 常用於寫腳本來自動化資源配置。您可以將 Azure CLI 指令寫入 `.sh` 腳本文件中並執行，以便快速創建和配置資源。這對於如大規模配置集群、設定網路環境或搭建複雜的分散式架構等場景非常有用。
Azure CLI 是構建自動化、可重現雲端架構的重要工具，特別是在 DevOps 流程中。

#### Azure CLI 腳本：建立和配置 Linux MPI 集群
```bash
#!/bin/bash

# 定義變數
RESOURCE_GROUP="MPIClusterGroup"
LOCATION="eastus"
VNET_NAME="MPIClusterVNet"
SUBNET_NAME="MPIClusterSubnet"
NSG_NAME="MPIClusterNSG"
VM_ADMIN_USER="azureuser"
SSH_KEY_PATH="~/.ssh/id_rsa.pub"
NUM_NODES=4
VM_SIZE="Standard_D2s_v3"
VM_IMAGE="UbuntuLTS"

# 步驟 1：建立資源群組
az group create --name $RESOURCE_GROUP --location $LOCATION

# 步驟 2：建立虛擬網路和子網路
az network vnet create --resource-group $RESOURCE_GROUP --name $VNET_NAME --address-prefix 10.0.0.0/16 \
    --subnet-name $SUBNET_NAME --subnet-prefix 10.0.1.0/24

# 步驟 3：建立網路安全群組，開放必要端口
az network nsg create --resource-group $RESOURCE_GROUP --name $NSG_NAME
az network nsg rule create --resource-group $RESOURCE_GROUP --nsg-name $NSG_NAME --name AllowSSH \
    --protocol tcp --priority 1000 --destination-port-range 22 --access allow
az network nsg rule create --resource-group $RESOURCE_GROUP --nsg-name $NSG_NAME --name AllowNFS \
    --protocol tcp --priority 1010 --destination-port-range 2049 --access allow
az network nsg rule create --resource-group $RESOURCE_GROUP --nsg-name $NSG_NAME --name AllowLDAP \
    --protocol tcp --priority 1020 --destination-port-range 389 --access allow

# 步驟 4：創建主節點虛擬機器並安裝 NFS 和 LDAP
for i in $(seq 0 $((NUM_NODES - 1)))
do
  NODE_NAME="mpinode$i"
  az vm create \
    --resource-group $RESOURCE_GROUP \
    --name $NODE_NAME \
    --size $VM_SIZE \
    --image $VM_IMAGE \
    --admin-username $VM_ADMIN_USER \
    --ssh-key-values $SSH_KEY_PATH \
    --vnet-name $VNET_NAME \
    --subnet $SUBNET_NAME \
    --nsg $NSG_NAME \
    --no-wait
done

# 等待所有虛擬機器創建完成
az vm wait --created --ids $(az vm list --resource-group $RESOURCE_GROUP --query "[].id" -o tsv)

# 取得所有節點的 IP 地址並將其添加到 /etc/hosts 中
HOSTS_FILE="/etc/hosts"
echo "Updating /etc/hosts with VM IP addresses..."
for i in $(seq 0 $((NUM_NODES - 1)))
do
  NODE_NAME="mpinode$i"
  NODE_IP=$(az vm show --resource-group $RESOURCE_GROUP --name $NODE_NAME --show-details --query publicIps -o tsv)
  echo "$NODE_IP $NODE_NAME" | sudo tee -a $HOSTS_FILE
done

# 步驟 5：在主節點上設置 NFS 伺服器
MAIN_NODE="mpinode0"
ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$MAIN_NODE << 'EOF'
sudo apt update
sudo apt install -y nfs-kernel-server slapd ldap-utils nfs-common openmpi-bin openmpi-common libopenmpi-dev
sudo mkdir -p /mnt/shared
sudo chown nobody:nogroup /mnt/shared
echo "/mnt/shared *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
EOF

# 步驟 6：在所有計算節點上掛載 NFS 共享
for i in $(seq 1 $((NUM_NODES - 1)))
do
  NODE_NAME="mpinode$i"
  ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$NODE_NAME << 'EOF'
sudo apt update
sudo apt install -y nfs-common
sudo mkdir -p /mnt/shared
echo "mpinode0:/mnt/shared /mnt/shared nfs defaults 0 0" | sudo tee -a /etc/fstab
sudo mount -a
EOF
done

# 步驟 7：配置 LDAP 用戶管理（在主節點上）
ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$MAIN_NODE << 'EOF'
sudo dpkg-reconfigure slapd
sudo ldapadd -x -D cn=admin,dc=example,dc=com -W -f base.ldif
EOF

# 步驟 8：配置 SSH 免密登入
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
for i in $(seq 1 $((NUM_NODES - 1)))
do
  NODE_NAME="mpinode$i"
  ssh-copy-id -i ~/.ssh/id_rsa.pub $VM_ADMIN_USER@$NODE_NAME
done

# 步驟 9：配置 NTP 時間同步（主節點設置為 NTP 伺服器）
ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$MAIN_NODE << 'EOF'
sudo apt install -y ntp
EOF

# 配置計算節點為 NTP 客戶端
for i in $(seq 1 $((NUM_NODES - 1)))
do
  NODE_NAME="mpinode$i"
  ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$NODE_NAME << 'EOF'
sudo apt install -y ntp
EOF
done

# 步驟 10：測試 MPI 安裝
ssh -o StrictHostKeyChecking=no $VM_ADMIN_USER@$MAIN_NODE << 'EOF'
mpicc -o hello_mpi <<EOF2
#include <mpi.h>
#include <stdio.h>

int main(int argc, char** argv) {
    MPI_Init(&argc, &argv);
    int world_rank;
    MPI_Comm_rank(MPI_COMM_WORLD, &world_rank);
    printf("Hello world from rank %d\n", world_rank);
    MPI_Finalize();
    return 0;
}
EOF2
mpirun -np $NUM_NODES -hostfile /mnt/shared/hosts ./hello_mpi
EOF

```