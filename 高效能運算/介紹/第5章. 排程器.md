第5章. 計算排程器 (Scheduler)
---


在高效能計算（HPC）中，結合 Scheduler 和 MPI的能力是非常常見的，這樣可以最大化資源利用率，並有效管理平行工作負載。雖然這兩個工具都至關重要，但它們的用途各不相同。這裡深入探討了 Scheduler 和 MPI，重點說明了 Scheduler 所能實現而 MPI 無法達成的功能。理解這些差異有助於用戶在複雜的計算環境中做出合理的工作負載管理決策。

**Scheduler 概述**
Scheduler 是用於管理 HPC 環境中計算資源和作業的工具。常見的例子包括 SLURM、PBS 和 LSF。它們的主要職責包括：

- **多用戶資源分配**：確保多個用戶之間的資源分配公平。
- **作業排程**：根據各種策略（如優先級、資源可用性和時間）來分配資源並管理作業的執行。

除了這些基本功能之外，Scheduler 還具備額外的功能，能在資源管理和系統效率上提供顯著的優勢，這些都是 MPI 所無法匹敵的。

**Scheduler 的獨特功能**

1. **多租戶管理**
   Scheduler 支援多個用戶同時使用，實現有效的隔離和公平的資源分配。不同的專案和用戶被分配不同的優先級，確保沒有單一用戶能獨佔系統資源。相較之下，MPI 主要用於平行處理，缺乏獨立管理多個用戶或控制共享資源的能力。

2. **配額管理與資源分配**
   Scheduler 工具能設定配額以管理用戶的資源消耗，這些配額限制每個用戶可以使用的最大 CPU、記憶體或運行時間，防止資源過度使用並確保其他用戶的資源可用性。相比之下，MPI 僅在 Scheduler 分配的資源範圍內運行，無法自主設定配額來限制資源使用。

3. **作業優先級與策略靈活性**
   Scheduler 系統允許管理員根據用戶定義的策略設置動態作業優先級，根據緊急程度或系統需求來調整作業的執行順序。像 SLURM 這樣的 Scheduler 可以優先處理緊急任務，同時將不太重要的作業放入低優先級的隊列中。相較之下，MPI 只是純粹的平行計算框架，缺乏作業優先級的能力，假設所有進程的重要性相同。

4. **作業恢復與錯誤管理**
   Scheduler 工具提供強大的作業恢復和容錯功能。例如，如果某個節點發生故障，Scheduler 可以自動將作業重新排程到其他節點，無需用戶干預，並提供錯誤報告以進行故障排除。而 MPI 則需要用戶自行編寫代碼來處理進程故障，使得恢復過程更加繁瑣且具體應用相關。



5. **作業排程與自動化**
   Scheduler 支援自動化作業排程，允許用戶設定特定的作業開始時間或重複執行計劃，從而提高集群效率並減少人力干預。例如，用戶可以在非高峰期安排定期的數據分析任務。而 MPI 需要手動啟動，沒有內建的自動化排程支持。

6. **監控與報告**
   Scheduler 可以生成資源使用的詳細統計數據和報告，包括作業等待時間、資源消耗和用戶活動等。這些數據對於系統管理員來說至關重要，因為它們可以用來優化資源分配並識別瓶頸問題。而 MPI 並不包含任何監控功能，用戶必須依賴額外的工具來收集相關信息。

7. **靈活的資源共享政策**
   Scheduler 支援多種資源共享政策，例如 "公平分享（Fair Share）" 或 "先到先排（FIFO）"，以有效平衡用戶和專案之間的工作負載，防止單一作業壟斷資源。而 MPI 缺乏全局資源共享或用戶公平性的概念，它專注於執行期間的進程協調。



**結論**
Scheduler 和 MPI 互補，但它們在 HPC 環境中的角色根本不同。MPI 專注於平行計算過程中的進程協調，而 Scheduler 則確保多用戶環境中的資源分配、作業優先級、自動化和監控的效率。通過理解這些差異，HPC 實踐者可以更好地利用這兩種工具來實現計算任務的更高效率和可靠性。




### 7.2 典型工作流程：Scheduler + MPI 
在高效能計算（HPC）環境中，Scheduler 和 MPI 的結合可以說是非常常見的一種實踐方式，它們的聯合使用能夠最大化計算資源的利用率，並且充分發揮出並行計算的性能。以下我們來詳細說明 Scheduler + MPI 的協作運作模式和優勢。

當結合 **Scheduler** （排程器）和 **MPI** （Message Passing Interface）來進行高效能的計算時，整體流程大致如下： 
1. **提交 MPI 工作** ：
  - 用戶首先通過排程器（例如 SLURM, PBS, LSF 等）提交工作，通常會撰寫一個腳本來說明這次工作的需求，如 CPU 核心數、節點數、記憶體大小、計算時間等。

  - 這些需求會被 Scheduler 收集，然後根據集群中目前資源的可用狀態來決定何時開始執行該工作。
 
2. **資源分配** ：
  - Scheduler 會根據用戶的需求分配相應的計算資源，例如分配特定數量的節點和每個節點上的處理器核心。

  - 這些分配好的節點通常是空閒的，並且具備執行 MPI 程序的條件。
 
3. **MPI 作業運行** ：
  - 一旦 Scheduler 將資源分配好，MPI 程序就會在這些節點上啟動。

  - MPI 程序將被分配到各個節點上進行執行，這些程序會在運行期間使用 MPI 協議進行高效的進程間通信。

  - 這種通信方式讓各個節點能夠協同工作，例如對大型矩陣進行分布式計算，或是對模擬進行並行求解。

#### 使用 Scheduler + MPI 的優勢 
 
1. **高效資源利用** ：
  - Scheduler 能夠確保整個計算集群的資源得到最佳利用。通過合理的資源分配和任務排程，集群不會有閒置的資源，也不會有資源浪費的情況。

  - 當使用 MPI 時，Scheduler 可以把資源分配到最佳的位置上，以保證每個 MPI 任務都有足夠的資源來運行。
 
2. **簡化的工作流管理** ：
  - Scheduler 可以管理多個 MPI 任務，這些任務可能來自不同的用戶或屬於不同的項目。

  - 如果某個任務失敗，Scheduler 可以自動嘗試重啟，或者通過報告幫助用戶查找問題。
 
3. **並行性與擴展性** ：
  - MPI 本身是一個用來進行大規模並行計算的標準，通過 Scheduler 的支持，可以在許多節點上同時運行 MPI 任務，讓問題的求解可以在短時間內完成。

  - 通過 Scheduler，MPI 任務可以隨著計算需求的增加動態地擴展，使用更多的節點和核心進行計算。
 
4. **提高穩定性和可管理性** ：
  - Scheduler 不僅可以監控資源的使用情況，也可以幫助解決資源競爭的問題。這對於多個 MPI 任務同時運行的情況非常有用，因為它能夠平衡資源，防止死鎖和資源衝突的發生。

#### 例子：使用 SLURM 排程器和 MPI 

假設你在一個 HPC 集群中使用 SLURM 作為排程器，並且需要執行一個 MPI 程序，可以使用一個腳本來提交這個任務。例如以下的 Bash 腳本：


```bash
#!/bin/bash
#SBATCH --job-name=my_mpi_job          # 設定工作名稱
#SBATCH --nodes=4                      # 請求4個計算節點
#SBATCH --ntasks-per-node=8            # 每個節點上運行8個 MPI 進程
#SBATCH --time=02:00:00                # 計算時間限制為2小時
#SBATCH --partition=compute            # 使用的排程隊列

module load mpi                        # 載入 MPI 模組 (假設集群需要顯式載入)

srun --mpi=pmix my_mpi_program         # 使用 srun 運行 MPI 程序
```

在這個例子中：
 
- `#SBATCH` 指令行是對 Scheduler 的請求，表示資源需求（例如節點數量和時間）。
 
- `srun --mpi=pmix my_mpi_program` 指令將通過 SLURM 排程器在所有分配的節點上運行 `my_mpi_program`，並且自動處理 MPI 進程的啟動和節點間的通信。


