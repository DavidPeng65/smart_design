模擬軟體之 GUI 設計
---

### 前言：為何 GUI 在工程模擬中至關重要？

圖形用戶界面（Graphical User Interface, GUI）是連接複雜工程模擬內核與終端使用者的橋樑。在物理工程模擬領域，軟體需要處理的參數繁多、設定複雜、數據維度高（例如3D電磁場、S參數矩陣）。如果沒有一個設計精良的GUI，這些強大的模擬工具將僅限於少數能夠熟練編寫腳本和配置文件的專家使用。

一個卓越的GUI設計，其目標不僅是「能用」，更是要實現「易用」與「高效」。它能夠引導使用者遵循正確的模擬流程、直觀地展示複雜的几何模型、清晰地呈現模擬結果，並在過程中提供即時反饋，從而大幅降低使用門檻，提高工程師的工作效率，並減少因錯誤配置導致的模擬失敗。本章節將深入探討構建一個強大、靈活且用戶友好的工程模擬GUI所需的關鍵原則、架構和技術。

-----

### 1\. GUI 設計核心原則

在開始設計任何界面元素之前，我們必須建立一套指導思想。這些原則是評估設計優劣的標準，確保最終產品的一致性、可用性和專業性。

#### 1.1 清晰性與簡潔性 (Clarity & Simplicity)

工程模擬本身已經足夠複雜，GUI的職責是簡化它，而不是增加額外的認知負擔。

  * **避免雜亂**：只在界面上放置當前任務必要的控件。將高級選項或不常用的功能隱藏在「高級設定」對話框或次級選單中。
  * **清晰標記**：所有按鈕、標籤、選單項都應使用無歧義的術語。例如，使用「運行模擬」而非「執行」，使用「介電常數」而非「Er」。
  * **視覺層次**：使用留白、分組框（GroupBox）和字體大小來創建清晰的視覺層次，引導用戶的視線首先關注最重要的部分。

#### 1.2 一致性 (Consistency)

一致性是降低學習成本的關鍵。使用者應當能夠將在軟體一個部分學到的操作邏輯應用到其他部分。

  * **內部一致性**：軟體內所有模組的視覺風格和操作邏輯應保持一致。例如，「確定」按鈕應始終在對話框的右下角，「刪除」圖標應始終相同。
  * **外部一致性**：應遵循操作系統的設計規範（例如，Windows、macOS、Linux的選單欄位置和快捷鍵習慣）。這使得熟悉該系統的使用者能更快上手。

#### 1.3 反饋 (Feedback)

系統必須始終讓使用者知道當前發生了什麼。

  * **即時反饋**：點擊按鈕時應有視覺變化（例如按下效果）。
  * **狀態反饋**：例如，「狀態欄」應顯示系統是「準備就緒」、「正在忙碌（例如：網格剖分中...）」還是「模擬完成」。
  * **進度反饋**：對於耗時的操作（如模擬運行、大型文件導入），必須提供進度條（ProgressBar）或百分比顯示，避免使用者以為程式已崩潰。

#### 1.4 用戶控制與自由 (User Control & Freedom)

使用者應感覺自己是系統的主導者，而不是被系統所束縛。

  * **可撤銷操作**：提供「復原」（Undo）和「重做」（Redo）功能至關重要。
  * **清晰的退出路徑**：使用者應能隨時中斷一個耗時的操作（例如「停止模擬」按鈕）。
  * **非模態操作**：盡量使用非模態對話框（Non-modal Dialogs）。例如，使用者在查看「材料庫」時，仍應能操作主視窗的3D視圖。

#### 1.5 錯誤預防與處理 (Error Prevention & Handling)

最好的錯誤訊息是根本不需要出現的錯誤訊息。

  * **預防**：提供合理的默認值（例如，默認阻抗為50歐姆）。在用戶輸入無效值（例如負數的頻率）時立即提示，而不是等到點擊「運行」時才報錯。
  * **處理**：當錯誤不可避免時，錯誤訊息必須清晰、具體，並提供解決方案。錯誤訊息「Error -501」是無用的；「錯誤：未能找到材料 'FR-4'。請檢查材料庫是否已正確加載？」則是有益的。

#### 1.6 靈活性與效率 (Flexibility & Efficiency)

軟體應同時服務於新手和專家。

  * **新手導向**：提供「嚮導」（Wizards）模式，一步步引導新手完成複雜的設定，例如 SI/PI 自動化流程。
  * **專家導向**：提供快捷鍵（例如 `Ctrl+R` 運行模擬）、命令行介面和腳本功能，讓專家可以繞過GUI，實現高效的自動化操作。

-----

### 2\. GUI 核心組件佈局與功能

一個典型的工程模擬軟體GUI通常由以下幾個關鍵區域組成，它們協同工作，為使用者提供一個完整的操作環境。

#### 2.1 選單欄 (Menu Bar)

選單欄是軟體功能的「總地圖」，提供對所有功能的訪問入口。一個邏輯清晰的選單結構至關重要。

  * **標準選單**：
      * **檔案 (File)**：新建專案、打開專案、保存、另存為、導入 (Import Design)、導出 (Export Results)、設定/偏好 (Settings/Preferences)、退出。
      * **編輯 (Edit)**：復原、重做、複製、貼上、刪除、查找。
      * **視圖 (View)**：控制各個面板（如屬性、日誌、專案樹）的顯示與隱藏、工具欄、縮放、平移。
  * **領域特定選單**：將特定領域的流程（如 `Apps`）和輔助功能（如 `Tools`）分開，是業界的良好實踐。
      * **Apps (應用流程)**：這應包含針對特定工作流的自動化套件。
          * `SI Automation` (信號完整性自動化)
          * `PI Automation` (電源完整性自動化)
          * `EMI Automation` (電磁干擾自動化)
      * **Tools (工具集)**：提供輔助功能和高級工具。
          * `Script Manager` (腳本管理器)：允許用戶編寫和執行自定義腳本。
          * `Material Library` (材料庫管理器)
          * `Component Library` (元件庫管理器)
          * `Options / Preferences` (全域設定)
      * **Help (幫助)**：
          * `Documentation` (本地或在線文檔)
          * `Examples` (範例工程)
          * `About` (關於軟體、版本號、許可證信息)

#### 2.2 工具欄 (Toolbar)

工具欄提供對選單欄中最常用功能的快速訪問，通常以圖標形式展現。例如：新建、打開、保存、復原/重做、運行模擬、停止模擬、平移、縮放、旋轉視圖等。

#### 2.3 標籤頁面板 (Tabs Panel)

Tabs Panel 是組織模擬工作流程的核心。採用按流程劃分（例如 SI/PI Automation）是現代模擬軟體的最佳實踐，它將一個複雜的任務分解為一系列線性的、可管理的步驟。

  * **流程導向設計 (Workflow-Driven Design)**：

      * 以 `SI Automation` 為例，Tabs 的順序清晰地定義了操作步驟：
        1.  **Import Design (導入設計)**：選擇 `.brd` 文件、層疊結構設定、元件選擇。
        2.  **Setup Ports (設定端口)**：在2D/3D視圖中選擇引腳，定義端口類型（單端、差分）、阻抗。
        3.  **Setup Simulation (設定模擬)**：選擇求解器類型 (SYZ)、設定頻率掃描範圍 (e.g., 0-20 GHz)、設定網格剖分選項。
        4.  **Run SYZ Simulation (運行模擬)**：一個「運行」按鈕，附帶一個日誌窗口顯示求解器進度。
        5.  **Analyze IL/RL (分析結果)**：顯示S參數圖表 (插入損耗/Insertion Loss, 回波損耗/Return Loss)、TDR/TDT分析、Pass/Fail 判斷。

  * **共用與特定模組 (Shared vs. Specific Tabs)**：

      * **共用模組**：如 `Import Design` 和 `Setup Simulation`，它們在 SI 和 PI 流程中可能高度相似。將它們設計成可重用的QT組件（Widgets），可以大幅減少開發和維護成本。例如，`Import Design` 模組可以通過參數配置來決定是導入 SI 相關的引腳還是 PI 相關的電源/地網絡。
      * **特定模組**：如 `Setup Ports` (SI) 和 `Setup Sources and Sinks` (PI)，以及 `Analyze IL/RL` (SI) 和 `Analyze Power Tree` (PI)。這些是特定領域的核心功能，需要專門設計。

#### 2.4 主視窗 (Main Viewport)

這是GUI的核心視覺區域，用於顯示和操作2D（如PCB佈局）或3D（如封裝、連接器）的幾何模型。它必須支持：

  * **渲染**：清晰顯示幾何、材料、端口、網格和場圖。
  * **交互**：平移 (Pan)、縮放 (Zoom)、旋轉 (Rotate)。
  * **選擇**：高亮顯示並允許使用者點選模型上的對象（如引腳、過孔、面），以便在「屬性面板」中對其進行編輯。

#### 2.5 停靠窗口 (Dockable Windows)

這些是輔助面板，可以被使用者自由拖動、停靠在主視窗四周或浮動。

  * **專案樹 (Project Tree)**：以樹狀結構顯示當前專案的所有組件：幾何模型、材料、邊界條件、端口、模擬設定、結果。
  * **屬性面板 (Properties Panel)**：上下文感知面板。當使用者在「專案樹」或「主視窗」中選擇某個對象（例如一個端口）時，此面板會自動顯示並允許編輯該對象的所有屬性（如阻抗、類型等）。
  * **日誌/訊息窗口 (Log/Message Window)**：顯示來自模擬器或GUI操作的詳細信息、警告和錯誤。

#### 2.6 狀態欄 (Status Bar)

狀態欄是提供即時、非干擾性反饋的關鍵。

  * **功能**：顯示當前模擬狀態（準備就緒、正在運行、已完成、錯誤）、操作進度（例如「網格剖分：75%」）、滑鼠在主視窗中的坐標、當前使用的單位（mm, GHz）。
  * **顏色區分**：
      * **綠色**：操作成功完成 / 系統準備就緒。
      * **藍色/灰色**：正常運行中 / 訊息提示。
      * **黃色**：警告（例如「模擬已完成，但收斂性較差」）。
      * **紅色**：嚴重錯誤（例如「模擬失敗：內存不足」）。

-----

### 3\. MVC 架構設計 (Model-View-Controller)

為了構建一個可維護、可擴展的大型GUI應用，採用成熟的軟體架構至關重要。MVC 是一種將應用程式邏輯與用戶界面分離的經典設計模式。

#### 3.1 Model (模型)

Model 是應用的「大腦」和「心臟」。它封裝了所有的數據和業務邏輯，完全獨立於用戶界面。

  * **在模擬軟體中**：Model 層代表了整個「專案」。它包含：
      * 數據結構：材料列表、幾何對象、端口定義、求解器設定。
      * 業務邏輯：計算有效性（例如「端口是否已定義在導體上？」）、保存/加載專案文件、觸發模擬器（與後端腳本交互）。
      * 狀態管理：維護當前模擬的狀態。
  * **關鍵特性**：Model 不知道也不關心 View 是什麼樣子的。它不包含任何 `QPushButton` 或 `QLabel`。

#### 3.2 View (視圖)

View 是使用者能看到並與之交互的界面。它負責「呈現」Model 的數據。

  * **在模擬軟體中**：View 層就是 `gui.py` 和 `/tabs` 目錄下的所有 `QWidget`。
      * 它從 Model 獲取數據並顯示它們（例如，在 `QLineEdit` 中顯示端口阻抗，在 `QTabWidget` 中顯示分析圖表）。
      * 它將使用者的原始操作（點擊、輸入）傳遞給 Controller。
  * **關鍵特性**：View 只負責顯示，不包含任何業務邏輯。

#### 3.3 Controller (控制器)

Controller 是 Model 和 View 之間的「協調者」。

  * **在模擬軟體中**：Controller 監聽來自 View 的事件（例如「`run_button` 被點擊」）。
      * 當事件發生時，Controller 會「翻譯」這個事件，並調用 Model 上相應的方法（例如 `model.start_simulation()`）。
      * 當 Model 的數據發生變化時（例如模擬完成），Model 會通知 Controller（或 View 通過觀察者模式直接監聽 Model），Controller 接著會更新 View 來反映新的狀態（例如，啟用「Analyze」標籤頁，更新狀態欄為「模擬完成」）。
  * **PySide/PyQt 中的實現**：Qt 的「信號與槽」(Signals & Slots) 機制是實現 MVC 中 View 和 Controller 之間通信的完美工具。

#### 3.4 MVC 的優勢

  * **可維護性**：GUI（View）和後端邏輯（Model）分離，修改界面不會影響模擬核心，反之亦然。
  * **可測試性**：Model 可以被獨立進行單元測試，無需啟動任何GUI，極大提高了軟體質量。
  * **靈活性**：可以為同一個 Model 開發多個 View。例如，一個用於桌面的完整 PySide6 View，和一個用於Web的簡易 View，它們共享同一個 Model 核心。

-----

### 4\. QT Widgets 與模組化實現

PySide6（或 PyQt）是基於 C++ Qt 框架的 Python 綁定，是開發專業工程軟體GUI的首選。

#### 4.1 常用 QT Widgets 詳解 (擴展)

以下是 QT Widgets 在模擬軟體中的具體應用場景：

  * **佈局 (Layouts)**: `QVBoxLayout`, `QHBoxLayout`, `QGridLayout`

      * **應用**：這是構建結構化界面的基礎。例如，`Setup Ports` 標籤頁左側可能是一個 `QVBoxLayout`（包含端口列表 `QListWidget` 和「添加/刪除」按鈕 `QPushButton`），右側是主視窗。這兩個部分由一個 `QHBoxLayout` 組織。

  * **容器 (Containers)**: `QTabWidget`, `QGroupBox`

      * **應用**：`QTabWidget` 用於實現主工作流程（如 Import, Setup, Run）。`QGroupBox` 用於將相關設定分組，例如在 `Setup Simulation` 標籤頁中，可以有一個標題為「頻率掃描 (Frequency Sweep)」的 `QGroupBox`，內部包含「起始頻率」、「停止頻率」和「步長」的 `QLineEdit`。

  * **輸入控件 (Input Widgets)**:

      * `QPushButton`：觸發動作，如「運行模擬」、「導入文件」。
      * `QLineEdit`：輸入單行文本或數值，如「阻抗：50」。應配合 `QValidator` 來限制只能輸入數字。
      * `QComboBox`：下拉選單，用於從一組固定選項中選擇，如「材料：FR-4, Rogers\_4003, Air」。
      * `QCheckBox`：「啟用/禁用」選項，如「[x] 啟用差分對」。
      * `QRadioButton`：從多個互斥選項中選擇一個，如「網格類型：(o) 快速 (o) 精確」。

  * **顯示控件 (Display Widgets)**:

      * `QLabel`：顯示標籤、說明文字或狀態圖標。
      * `QProgressBar`：在狀態欄或 `Run` 標籤頁中顯示模擬進度。
      * `QTextEdit`：用於顯示多行日誌訊息或作為內置的 `Script Manager` 編輯器。

  * **高級控件 (Advanced Widgets)**:

      * `QFileDialog`：用於「導入設計」或「保存專案」時彈出的文件選擇對話框。
      * `QMessageBox`：用於顯示錯誤、警告或確認訊息（例如「確定要刪除此端口嗎？」）。

#### 4.2 模組化與腳本交互

一個常見且優秀的模組化實踐是採用 `gui.py`, `main.py`, 和 `/tabs` 目錄的結構。

  * `main.py`：應用程式的入口。它初始化 `QApplication`，創建主窗口 `MainWindow`（在 `gui.py` 中定義），並顯示它。
  * `gui.py` (或 `main_window.py`)：定義 `QMainWindow` 類。這個類負責：
    1.  創建頂層選單 (`QMenuBar`) 和狀態欄 (`QStatusBar`)。
    2.  創建一個 `QTabWidget` 作為中央控件。
    3.  **動態加載** `/tabs` 目錄下的所有標籤頁模組。
    4.  將 Model 實例傳遞給每個標籤頁，以便它們可以讀取和修改數據。
    5.  連接來自標籤頁的信號（例如「運行按鈕被點擊」）到 Controller 的槽。
  * `/tabs/` 目錄：
      * `import_design_tab.py`, `setup_ports_tab.py` ...
      * 每個文件定義一個繼承自 `QWidget` 的類（例如 `class ImportDesignTab(QWidget):`）。
      * 每個類在其構造函數中創建自己內部的佈局和 Widgets。
      * **與腳本的互動**：當標籤頁上的按鈕（例如 `Run SYZ Simulation`）被點擊時，它不應該自己直接調用 `os.system('python run_syz.py')`。這會阻塞GUI。
      * **正確的做法**：
        1.  按鈕點擊時，View（標籤頁）發出一個信號，例如 `run_simulation_requested`。
        2.  Controller（或 `gui.py`）中的一個槽 (Slot) 接收此信號。
        3.  該槽 (Slot) 創建一個 `QThread`（Qt線程）或使用 `QProcess` 來**異步執行**後端腳本。
        4.  `QProcess` 可以捕獲腳本的標準輸出（日誌），並實時更新到GUI的 `QTextEdit` 日誌窗口中。
        5.  當腳本執行完成後，`QProcess` 發出 `finished` 信號，GUI 隨之更新狀態欄。

-----

### 5\. AI 輔助開發與擴展

在現代GUI開發中，AI Agent（如大型語言模型）已成為強大的助手。以下 AI 輔助開發的 Prompt 範例展示了如何高效地利用 AI。

### 5.1 AI 輔助開發 Prompt 範例

**範例 1 (初始化創建)**：

```plaintext
請幫我生成一個PySide6 GUI程式碼，最上方為選單，中間為Tabs模組應該包含以下Tabs：Import Design、Setup Ports、Setup Simulation、Run SYZ Simulation和Analyze IL/RL。每個Tab應該包含一個標籤和一個按鈕，按鈕的功能執行腳本。請確保程式碼結構清晰，並包含必要的註解。

Tab 採模組設計，放在/tabs目錄下，主程式碼放在main.py中。 gui.py負責整合選單與Tabs Panel，並處理與腳本的互動。
```

  * **此範例的優點**：
      * **技術棧明確**：`PySide6`。
      * **結構清晰**：`選單` (頂部), `Tabs` (中間)。
      * **具體需求**：列出了 5 個
        Tab 的確切名稱。
      * **架構要求**：`模組設計`, `/tabs` 目錄, `main.py`, `gui.py`。
      * **功能要求**：`按鈕的功能執行腳本`。

**範例 2 (修改與擴展)**：

```plaintext
請幫我修改/tabs目錄下的gui.py程式碼，新增一個名為“Setup Simulation”的Tab。該Tab應該包含一個標籤和一個按鈕，按鈕的功能是執行setup_simulation.py腳本。請確保程式碼結構清晰，並包含必要的註解。
```

  * **此範例的優點**：
      * **上下文感知**：它假設 AI 知道上一個範例的目錄結構（`gui.py`, `/tabs`）。
      * **目標明確**：`新增` 一個 Tab。
      * **位置明確**：修改 `gui.py` 並在 `/tabs` 目錄下新增文件。
      * **細節具體**：Tab 名稱 `Setup Simulation`，包含 `一個標籤和一個按鈕`，按鈕功能 `執行 setup_simulation.py`。

#### 5.2 AI 輔助開發的最佳實踐

  * **用於腳本連接**：可以要求 AI 撰寫使用 `QProcess` 異步執行後端腳本的代碼，並捕獲其輸出。
  * **用於 MVC 重構**：可以提供一個單一文件的 GUI 腳本，要求 AI 將其重構為 MVC 架構，將數據邏輯提取到 `model.py` 中。
  * **用於複雜佈局**：可以描述一個複雜的佈局（例如「左側是可伸縮的樹狀視圖，右側是 3D 視圖，底部是日誌窗口」），讓 AI 生成 `QSplitter` 和 `QDockWidget` 的佈局代碼。

-----

### 6\. 專案管理功能

最後，一個專業的模擬軟體必須具備強大的專案管理功能。

#### 6.1 以專案為中心的工作流

每一次模擬都應被視為一個「專案」。

  * **專案目錄**：GUI 應強制或建議使用者為每個新工作建立一個專案目錄。
  * **專案文件**：GUI 應維護一個核心的專案文件（例如 `.proj`），通常使用 JSON 或 XML 格式。此文件存儲了：
      * 指向輸入文件（`.brd`）的路徑。
      * 所有的 GUI 設定（端口、材料、模擬參數）。
      * 指向結果文件的路徑。
  * **中間文件**：所有模擬器產生的中間文件（網格、矩陣）都應整齊地存放在專案目錄下的子目錄中（例如 `/simulation/run1/`），而不是污染原始設計目錄。

#### 6.2 GUI 中的專案管理功能

選單欄中的「檔案」選單應支持以下功能：

  * **新建專案 (New Project)**：彈出對話框，要求使用者選擇一個空的目錄並為專案命名。GUI 隨即創建該目錄和一個初始的 `.proj` 文件。
  * **打開專案 (Open Project)**：允許使用者選擇一個 `.proj` 文件。GUI 讀取該文件，解析其內容到 Model 中，然後 View 更新以顯示專案的所有設定。
  * **保存專案 (Save Project)**：將 Model 中的當前所有設定序列化（Serialize）並寫回到 `.proj` 文件中。
  * **刪除專案**：提供從 GUI 中安全刪除整個專案目錄的功能（需有警告確認）。

### 總結

設計一個用於工程模擬的 GUI 是一項複雜但回報豐厚的任務。它不僅僅是拖放按鈕，更是關於理解使用者的工作流程、構建可維護的軟體架構（如MVC）、以及巧妙運用 Qt Widgets 等工具來呈現複雜的數據。通過遵循清晰的設計原則，採用模組化的方法，並利用 AI 輔助開發，我們可以創造出既強大又易於使用的模擬工具，真正為工程師賦能。